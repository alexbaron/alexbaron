name: Update README with Languages

on:
  schedule:
    # Run daily at 00:00 UTC
    - cron: '0 0 * * *'
  workflow_dispatch: # Allow manual trigger
  push:
    branches:
      - main

jobs:
  update-readme:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Fetch languages and update README
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          node << 'EOF'
          const https = require('https');
          const fs = require('fs');
          
          const username = 'alexbaron';
          const token = process.env.GITHUB_TOKEN;
          
          function httpsGet(url) {
            return new Promise((resolve, reject) => {
              const options = {
                headers: {
                  'User-Agent': 'GitHub-Profile-Updater',
                  'Authorization': `Bearer ${token}`
                }
              };
              https.get(url, options, (res) => {
                let data = '';
                res.on('data', chunk => data += chunk);
                res.on('end', () => {
                  if (res.statusCode === 200) {
                    resolve(JSON.parse(data));
                  } else {
                    reject(new Error(`HTTP ${res.statusCode}: ${data}`));
                  }
                });
              }).on('error', reject);
            });
          }
          
          async function main() {
            // Fetch all repositories for the user with pagination
            let page = 1;
            let allRepos = [];
            let repos;
            
            do {
              repos = await httpsGet(`https://api.github.com/users/${username}/repos?per_page=100&page=${page}`);
              allRepos = allRepos.concat(repos);
              page++;
            } while (repos.length === 100);
            
            console.log(`Found ${allRepos.length} repositories`);
            
            // Aggregate languages across all repositories
            const languageStats = {};
            
            for (const repo of allRepos) {
              if (repo.fork) continue; // Skip forked repositories
              
              try {
                const languages = await httpsGet(`https://api.github.com/repos/${username}/${repo.name}/languages`);
                
                for (const [lang, bytes] of Object.entries(languages)) {
                  if (!languageStats[lang]) {
                    languageStats[lang] = 0;
                  }
                  languageStats[lang] += bytes;
                }
              } catch (err) {
                console.error(`Error fetching languages for ${repo.name}:`, err.message);
              }
            }
            
            // Sort languages by total bytes
            const sortedLanguages = Object.entries(languageStats)
              .sort((a, b) => b[1] - a[1])
              .map(([lang, bytes]) => {
                const kb = (bytes / 1024).toFixed(2);
                const mb = (bytes / (1024 * 1024)).toFixed(2);
                return { lang, bytes, kb, mb };
              });
            
            // Calculate total bytes for percentage
            const totalBytes = sortedLanguages.reduce((sum, item) => sum + item.bytes, 0);
            
            // Generate markdown content
            let languagesMarkdown = '## ðŸ“Š Languages Used Across My Repositories\n\n';
            
            if (sortedLanguages.length === 0) {
              languagesMarkdown += '_No language data available_\n';
            } else {
              languagesMarkdown += '| Language | Usage | Percentage |\n';
              languagesMarkdown += '|----------|-------|------------|\n';
              
              sortedLanguages.forEach(({ lang, bytes, kb, mb }) => {
                const percentage = ((bytes / totalBytes) * 100).toFixed(2);
                const sizeDisplay = bytes > 1024 * 1024 ? `${mb} MB` : `${kb} KB`;
                languagesMarkdown += `| ${lang} | ${sizeDisplay} | ${percentage}% |\n`;
              });
              
              languagesMarkdown += `\n**Total:** ${(totalBytes / (1024 * 1024)).toFixed(2)} MB across ${sortedLanguages.length} languages\n`;
              languagesMarkdown += `\n_Last updated: ${new Date().toISOString().split('T')[0]}_\n`;
            }
            
            // Read current README
            let readme = fs.readFileSync('README.md', 'utf8');
            
            // Replace or insert languages section
            const startMarker = '<!-- LANGUAGES-START -->';
            const endMarker = '<!-- LANGUAGES-END -->';
            
            const languagesSection = `${startMarker}\n${languagesMarkdown}\n${endMarker}`;
            
            if (readme.includes(startMarker) && readme.includes(endMarker)) {
              // Replace existing section
              const escapedStart = startMarker.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
              const escapedEnd = endMarker.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
              const regex = new RegExp(`${escapedStart}[\\s\\S]*${escapedEnd}`, 'g');
              readme = readme.replace(regex, languagesSection);
            } else {
              // Append to the end
              readme += '\n\n' + languagesSection + '\n';
            }
            
            // Write updated README
            fs.writeFileSync('README.md', readme);
            console.log('README.md updated successfully!');
          }
          
          main().catch(err => {
            console.error('Error:', err);
            process.exit(1);
          });
          EOF

      - name: Commit and push if changed
        run: |
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"
          git add README.md
          if git diff --quiet && git diff --staged --quiet; then
            echo "No changes to commit"
            exit 0
          fi
          git commit -m "Update README with language statistics"
          if git push; then
            echo "Successfully pushed changes"
          else
            echo "Failed to push changes"
            exit 1
          fi
